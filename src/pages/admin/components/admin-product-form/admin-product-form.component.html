<!-- src/app/pages/admin/admin-product-form/admin-product-form.component.html -->
<div class="admin-product-form-container" style="overflow-y: hidden; height: 100vh;">
  <div class="row g-0">
    <!-- Sidebar -->
    <div class="col-md-2 bg-dark min-vh-100">
      <app-admin-sidebar></app-admin-sidebar>
    </div>
    
    <!-- Main content -->
    <div class="col-md-10">
      <app-admin-header></app-admin-header>
      
      <div class="container mt-4" style="overflow-y: auto; height: calc(100vh - 100px);">
        <div class="row mb-4">
          <div class="col">
            <h2>{{isEditMode ? 'Edit' : 'Add'}} Product</h2>
            <p class="text-muted">{{isEditMode ? 'Update product information' : 'Create a new product'}}</p>
          </div>
          <div class="col-auto">
            <button type="button" class="btn btn-outline-secondary" routerLink="/admin/products">
              <i class="bi bi-arrow-left me-2"></i>Back to Products
            </button>
          </div>
        </div>

        <!-- Loading spinner -->
        <div *ngIf="isLoading" class="d-flex justify-content-center my-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Product form -->
        <form [formGroup]="productForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading">
          <div class="row g-4">
            <!-- Basic Information -->
            <div class="col-md-8">
              <div class="card mb-4">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                  <!-- Product Name -->
                  <div class="mb-3">
                    <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="name" formControlName="name"
                           [ngClass]="{'is-invalid': isFieldInvalid('name')}">
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('name')">
                      {{getErrorMessage('name')}}
                    </div>
                  </div>

                  <!-- Description -->
                  <div class="mb-3">
                    <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="description" rows="4" formControlName="description"
                              [ngClass]="{'is-invalid': isFieldInvalid('description')}"></textarea>
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('description')">
                      {{getErrorMessage('description')}}
                    </div>
                  </div>

                  <div class="row">
                    <!-- Category with Search -->
                    <div class="col-md-4 mb-3">
                      <label for="categoryId" class="form-label">Category <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <input 
                          type="text" 
                          class="form-control" 
                          placeholder="Search categories..."
                          (input)="onCategorySearch($event)">
                        <select class="form-select" 
                                id="categoryId" 
                                formControlName="categoryId"
                                [ngClass]="{'is-invalid': isFieldInvalid('categoryId')}">
                          <option value="">Select a category</option>
                          <option *ngFor="let category of filteredCategories" [value]="category.categoryId">{{category.name}}</option>
                        </select>
                      </div>
                      <div class="invalid-feedback" *ngIf="isFieldInvalid('categoryId')">
                        {{getErrorMessage('categoryId')}}
                      </div>
                    </div>

                    <!-- Subcategory -->
                    <div class="col-md-4 mb-3">
                      <label for="subcategoryId" class="form-label">Subcategory <span class="text-danger">*</span></label>
                      <select class="form-select" 
                              id="subcategoryId" 
                              formControlName="subcategoryId"
                              [ngClass]="{'is-invalid': isFieldInvalid('subcategoryId')}" 
                              [disabled]="!productForm.get('categoryId')?.value">
                        <option value="">Select a subcategory</option>
                        <option *ngFor="let subcategory of subcategories" [value]="subcategory.subcategoryId">
                          {{subcategory.name}}
                        </option>
                      </select>
                      <div class="invalid-feedback" *ngIf="isFieldInvalid('subcategoryId')">
                        {{getErrorMessage('subcategoryId')}}
                      </div>
                    </div>

                    <!-- Seller with Search -->
                    <div class="col-md-4 mb-3">
                      <label for="sellerId" class="form-label">Seller <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <input 
                          type="text" 
                          class="form-control" 
                          placeholder="Search sellers..."
                          (input)="onSellerSearch($event)">
                        <select class="form-select" 
                                id="sellerId" 
                                formControlName="sellerId"
                                [ngClass]="{'is-invalid': isFieldInvalid('sellerId')}">
                          <option value="">Select a seller</option>
                          <option *ngFor="let seller of filteredSellers" [value]="seller.sellerId">
                            {{seller.name}}
                          </option>
                        </select>
                      </div>
                      <div class="invalid-feedback" *ngIf="isFieldInvalid('sellerId')">
                        {{getErrorMessage('sellerId')}}
                      </div>
                    </div>
                  </div>

                  <!-- Has Variants Switch -->
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="hasVariants" formControlName="hasVariants">
                    <label class="form-check-label" for="hasVariants">This product has variants</label>
                  </div>
                </div>
              </div>

              <!-- Product Variants Section -->
              <div class="card mb-4" *ngIf="productForm.get('hasVariants')?.value">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Product Variants</h5>
                  <button type="button" class="btn btn-primary btn-sm" (click)="addVariant()">
                    <i class="bi bi-plus-circle me-1"></i>Add Variant
                  </button>
                </div>
                <div class="card-body">
                  <div formArrayName="variants">
                    <div *ngFor="let variant of variants.controls; let i = index" [formGroupName]="i" class="border rounded p-3 mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Variant #{{i + 1}}</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeVariant(i)" [disabled]="variants.length === 1">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>

                      <!-- Variant Name -->
                      <div class="mb-3">
                        <label [for]="'variantName' + i" class="form-label">Variant Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" [id]="'variantName' + i" formControlName="variantName"
                               [ngClass]="{'is-invalid': isVariantFieldInvalid(i, 'variantName')}">
                        <div class="invalid-feedback" *ngIf="isVariantFieldInvalid(i, 'variantName')">
                          Variant name is required
                        </div>
                      </div>

                      <div class="row">
                        <!-- Price -->
                        <div class="col-md-6 mb-3">
                          <label [for]="'price' + i" class="form-label">Price <span class="text-danger">*</span></label>
                          <input type="number" class="form-control" [id]="'price' + i" formControlName="price"
                                 [ngClass]="{'is-invalid': isVariantFieldInvalid(i, 'price')}">
                          <div class="invalid-feedback" *ngIf="isVariantFieldInvalid(i, 'price')">
                            Valid price is required
                          </div>
                        </div>

                        <!-- Discount Percentage -->
                        <div class="col-md-6 mb-3">
                          <label [for]="'discountPercentage' + i" class="form-label">Discount %</label>
                          <input type="number" class="form-control" [id]="'discountPercentage' + i" formControlName="discountPercentage"
                                 [ngClass]="{'is-invalid': isVariantFieldInvalid(i, 'discountPercentage')}">
                          <div class="invalid-feedback" *ngIf="isVariantFieldInvalid(i, 'discountPercentage')">
                            Discount must be between 0 and 100
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <!-- Stock -->
                        <div class="col-md-6 mb-3">
                          <label [for]="'stockQuantity' + i" class="form-label">Stock <span class="text-danger">*</span></label>
                          <input type="number" class="form-control" [id]="'stockQuantity' + i" formControlName="stockQuantity"
                                 [ngClass]="{'is-invalid': isVariantFieldInvalid(i, 'stockQuantity')}">
                          <div class="invalid-feedback" *ngIf="isVariantFieldInvalid(i, 'stockQuantity')">
                            Valid stock quantity is required
                          </div>
                        </div>

                        <!-- SKU -->
                        <div class="col-md-6 mb-3">
                          <label [for]="'sku' + i" class="form-label">SKU <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" [id]="'sku' + i" formControlName="sku"
                                 [ngClass]="{'is-invalid': isVariantFieldInvalid(i, 'sku')}">
                          <div class="invalid-feedback" *ngIf="isVariantFieldInvalid(i, 'sku')">
                            SKU is required
                          </div>
                        </div>
                      </div>

                      <!-- Variant Image URL -->
                      <div class="mb-3">
                        <label [for]="'variantImageUrl' + i" class="form-label">Image URL</label>
                        <input type="text" class="form-control" [id]="'variantImageUrl' + i" formControlName="variantImageUrl">
                      </div>

                      <!-- Default Variant Radio -->
                      <div class="form-check">
                        <input class="form-check-input" type="radio" [name]="'defaultVariant'" [id]="'defaultVariant' + i"
                               formControlName="isDefault" [value]="true" (change)="onDefaultVariantChange(i)">
                        <label class="form-check-label" [for]="'defaultVariant' + i">
                          Set as default variant
                        </label>
                      </div>

                      <!-- Available Switch -->
                      <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" [id]="'isAvailable' + i" formControlName="isAvailable">
                        <label class="form-check-label" [for]="'isAvailable' + i">Variant is available</label>
                      </div>
                    </div>

                    <!-- No variants message -->
                    <div *ngIf="variants.length === 0" class="text-center py-4">
                      <p class="text-muted mb-0">No variants added yet. Click "Add Variant" to create one.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pricing and Stock -->
            <div class="col-md-4">
              <div class="card mb-4" *ngIf="!productForm.get('hasVariants')?.value">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Pricing & Stock</h5>
                </div>
                <div class="card-body">
                  <!-- Base Price -->
                  <div class="mb-3">
                    <label for="basePrice" class="form-label">Base Price <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="basePrice" formControlName="basePrice"
                           [ngClass]="{'is-invalid': isFieldInvalid('basePrice')}">
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('basePrice')">
                      {{getErrorMessage('basePrice')}}
                    </div>
                  </div>

                  <!-- Discount -->
                  <div class="mb-3">
                    <label for="discountPercentage" class="form-label">Discount Percentage</label>
                    <input type="number" 
                           class="form-control" 
                           id="discountPercentage" 
                           formControlName="discountPercentage"
                           [ngClass]="{'is-invalid': isFieldInvalid('discountPercentage')}">
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('discountPercentage')">
                      {{getErrorMessage('discountPercentage')}}
                    </div>
                  </div>

                  <!-- Stock -->
                  <div class="mb-3">
                    <label for="stockQuantity" class="form-label">Stock Quantity <span class="text-danger">*</span></label>
                    <input type="number" 
                           class="form-control" 
                           id="stockQuantity" 
                           formControlName="stockQuantity"
                           [ngClass]="{'is-invalid': isFieldInvalid('stockQuantity')}">
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('stockQuantity')">
                      {{getErrorMessage('stockQuantity')}}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Image -->
              <div class="card mb-4">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Product Image</h5>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="mainImageFile" class="form-label">Main Image <span class="text-danger">*</span></label>
                    <input type="file" 
                           class="form-control" 
                           id="mainImageFile" 
                           accept="image/*"
                           (change)="onImageSelected($event)"
                           [ngClass]="{'is-invalid': isFieldInvalid('mainImageFile')}">
                    <div class="invalid-feedback" *ngIf="isFieldInvalid('mainImageFile')">
                      {{getErrorMessage('mainImageFile')}}
                    </div>
                  </div>

                  <!-- Image Preview -->
                  <div class="border rounded p-2 text-center">
                    <img [src]="imagePreview" 
                         class="img-fluid" 
                         style="max-height: 200px;"
                         *ngIf="imagePreview"
                         alt="Product preview">
                    <div class="text-muted py-4" *ngIf="!imagePreview">
                      No image selected
                    </div>
                  </div>
                </div>
              </div>

              <!-- Availability -->
              <div class="card mb-4">
                <div class="card-header bg-light">
                  <h5 class="mb-0">Availability</h5>
                </div>
                <div class="card-body">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="isAvailable" formControlName="isAvailable">
                    <label class="form-check-label" for="isAvailable">Product is available for sale</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit Buttons -->
          <div class="row mt-4 mb-5">
            <div class="col">
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-outline-secondary" routerLink="/admin/products">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary" [disabled]="productForm.invalid || isLoading">
                  <i class="bi" [ngClass]="{'bi-check-circle': isEditMode, 'bi-plus-circle': !isEditMode}"></i>
                  {{isEditMode ? 'Update' : 'Create'}} Product
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>