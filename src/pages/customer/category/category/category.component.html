<!-- category.component.html -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<app-up-arrow> </app-up-arrow>

<app-product-variant-modal
  [productId]="selectedProductId"
  [isOpen]="showVariantModal"
  (onClose)="closeVariantModal()"
  (onAddToCart)="handleModalAddToCart($event)">
</app-product-variant-modal>

<div class="category-page-container">
  <!-- Category Header -->
  <div class="category-header">
    <h1 class="category-title">{{ categoryName }}</h1>
    <div class="breadcrumb">
      <a [routerLink]="['/']">Home</a> / <span>{{ categoryName }}</span>
    </div>
  </div>

  <!-- Subcategories buttons -->
  <div class="subcategories-container">
    <button 
      class="subcategory-btn" 
      [class.active]="selectedSubcategoryId === ''"
      (click)="showAllProducts()">
      All
    </button>
    <button 
      *ngFor="let subcategory of subcategories" 
      class="subcategory-btn" 
      [class.active]="selectedSubcategoryId === subcategory.subcategoryId.toString()"
      (click)="filterBySubcategory(subcategory.subcategoryId.toString())">
      {{ subcategory.name }}
    </button>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="loading" class="loading-indicator">
    <i class="fas fa-spinner fa-spin"></i> Loading products...
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="error-message">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
  </div>

  <!-- Products grid -->
  <div *ngIf="!loading && !error" class="products-grid">
    <!-- No products message -->
    <div *ngIf="filteredProducts.length === 0" class="no-products">
      No products found in this category.
    </div>

    <!-- Product cards -->
    <div *ngFor="let product of displayedProducts" class="product-card">
      <div (click)="navigateToProductDetails(product.productId)">
        <!-- Discount badge -->
        <div class="discount-badge" *ngIf="product.discountPercentage > 0">
          -{{ product.discountPercentage }}%
        </div>
        
        <!-- Wishlist icon -->
        <div class="wishlist-icon" (click)="toggleWishlist($event, product.productId)">
          <i class="fa-heart" [ngClass]="{'fas': isInWishlist(product.productId), 'far': !isInWishlist(product.productId)}"></i>
        </div>
        
        <!-- Product image -->
        <div class="product-image">
          <img [src]="getFullImageUrl(product.mainImageUrl)" [alt]="product.name">
        </div>
        
        <!-- Product info -->
        <div class="product-info">
          <h3 class="product-name">{{ product.name }}</h3>
          
          <!-- Star rating -->
          <div class="product-rating" *ngIf="product.averageRating">
            <ng-container *ngFor="let i of [1, 2, 3, 4, 5]">
              <i class="fas fa-star star" [class.filled]="i <= product.averageRating"></i>
            </ng-container>
            <span *ngIf="product.averageRating" class="rating-count">({{ product.averageRating }})</span>
          </div>
          
          <div class="product-price">
            <span class="final-price">EGP {{ product.finalPrice }}</span>
            <span class="base-price" *ngIf="product.discountPercentage > 0">EGP {{ product.basePrice }}</span>
          </div>
          
          <!-- Seller info -->
          <div class="seller-info" *ngIf="product.sellerName">
            Sold by: {{ product.sellerName }}
          </div>
        </div>
      </div>
      
      <!-- Add to cart button -->
      <!-- <button 
  class="add-to-cart-btn" 
  [disabled]="addingToCart[product.productId]"
  (click)="addToCart($event, product.productId)">
  <span *ngIf="!addingToCart[product.productId]">Add to cart</span>
  <span *ngIf="addingToCart[product.productId]">
    <i class="fas fa-spinner fa-spin"></i> Adding...
  </span>
</button> -->

<button 
  class="add-to-cart-btn" 
  [disabled]="addingToCart[product.productId]"
  (click)="openVariantModal($event, product.productId)">
  <span *ngIf="!addingToCart[product.productId]">Add to cart</span>
  <span *ngIf="addingToCart[product.productId]">
    <i class="fas fa-spinner fa-spin"></i> Adding...
  </span>
</button>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div *ngIf="!loading && !error && totalItems > 0" class="pagination-container">
    <div class="pagination-info">
      Showing {{ (currentPage - 1) * pageSize + 1 }} - {{ Math.min(currentPage * pageSize, totalItems) }} of {{ totalItems }} products
    </div>
    
    <div class="pagination-controls">
      <!-- Previous page button -->
      <button 
        class="pagination-btn prev" 
        [disabled]="currentPage === 1"
        (click)="prevPage()">
        <i class="fas fa-chevron-left"></i>
      </button>
      
      <!-- Page numbers -->
      <div class="page-numbers">
        <button 
          *ngFor="let page of pages" 
          class="page-number" 
          [class.active]="page === currentPage"
          [class.ellipsis]="page < 0"
          [disabled]="page < 0"
          (click)="goToPage(page)">
          <span *ngIf="page > 0">{{ page }}</span>
          <span *ngIf="page < 0">...</span>
        </button>
      </div>
      
      <!-- Next page button -->
      <button 
        class="pagination-btn next" 
        [disabled]="currentPage === totalPages"
        (click)="nextPage()">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Toast notification -->
  <!-- Add a toast notification for confirmation -->
  <!-- <div *ngIf="showToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Item added to cart successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div> -->

</div>